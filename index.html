<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride 🌈｜Reservation Confirmation｜10/24 週五晚餐名單</title>
<style>
  :root{ --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --rainbow:linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6); --btn-grad:linear-gradient(90deg,#7dd3fc,#86efac); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",ui-sans-serif,system-ui;background: radial-gradient(800px 600px at 10% -10%, rgba(255,255,255,.06), transparent), var(--bg);color:var(--fg)}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:28px auto 64px;padding:0 14px}
  .tl .t1,.tl .t2,.tl .t3{color:#fff;text-shadow:0 0 8px rgba(255,255,255,.28),0 0 18px rgba(255,255,255,.12)}
  .tl .t1{font-size:28px;font-weight:900;line-height:1.15}
  .tl .t2{font-size:22px;font-weight:800;opacity:.95}
  .tl .t3{font-size:16px;font-weight:700;opacity:.9}
  .rainbow-line{height:2px;background:var(--rainbow);opacity:.6;border-radius:2px;margin:6px 0 14px}
  .rbtext{background:var(--rainbow);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 12px rgba(255,255,255,.08);font-weight:900;letter-spacing:.2px}
  .card{position:relative;border-radius:16px;padding:14px;border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03)}
  .row{display:grid;grid-template-columns:minmax(0,2fr) minmax(0,2fr) minmax(0,1fr);gap:8px;align-items:end}
  label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block}
  .input-wrap{display:flex;flex-direction:column;min-width:0}
  input,button{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1117;color:var(--fg);outline:none;font-size:14px}
  input::placeholder{color:#6b7280}
  button.primary{background:var(--btn-grad);border:0;color:#0b0c10;font-weight:900;letter-spacing:.2px}
  button.primary:hover{filter:saturate(1.08);}
  .preview{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
  .preview img{max-height:86px;border-radius:8px;border:1px solid #2b3244}
  #bgPreview{display:none !important;}
  .result-head{font-size:13px;color:var(--muted);margin:10px 2px 6px}
  .grid{display:flex;flex-direction:column;gap:6px}
  .person{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr;gap:6px;overflow:hidden}
  .line{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:nowrap}
  .left,.right{display:flex;gap:10px;align-items:center;min-width:0}
  .namebar{display:flex;align-items:center;gap:8px;min-width:0}
  .namebar .flag{font-size:18px;line-height:1;flex:0 0 auto}
  .namebar .country{flex:0 0 8px;max-width:8px;overflow:hidden;white-space:nowrap;opacity:0.6}
  .namebar .personN{color:#fff;font-weight:900;font-size:15px;flex:1 1 auto;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .namebar .ig{color:#aeb7c2;font-size:13px;text-align:right;flex:0 1 38%;max-width:40%;min-width:56px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (min-width:861px){ .namebar .personN,.namebar .ig{ color:#aeb7c2;font-size:13px;text-align:right;flex:0 1 38%;max-width:40%;min-width:56px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis } }
  @media (max-width:420px){ .tl .t1{font-size:24px}.tl .t2{font-size:18px}.tl .t3{font-size:14px}.btn{font-size:12px} .namebar .personN{font-size:15px} .namebar .ig{font-size:13px}}
  .status{display:inline-flex;align-items:center;gap:8px}
  .badge{position:relative;width:22px;height:22px;display:grid;place-items:center;filter:drop-shadow(0 1px 2px rgba(0,0,0,.45))}
  .badge svg{width:22px;height:22px;display:block}
  .badge.ok{color:var(--ok)} .badge.warn{color:var(--warn)} .badge.bad{color:var(--bad)}
  .badge .ring{fill:#0f1117;stroke:currentColor;stroke-width:2.6}
  .badge .glyph{stroke:#fff;stroke-width:1.9;stroke-linecap:round;stroke-linejoin:round;fill:none}
  .badge .glyph-text{fill:#fff;font-size:12px;font-family:ui-sans-serif,system-ui;dominant-baseline:middle;text-anchor:middle}
  .status-label{display:flex;flex-direction:column;line-height:1.05}
  .status-label .zh{font-size:12px}.status-label .en{font-size:11px;opacity:.9}
  .link-btn{padding:6px 9px;border-radius:10px;border:none;background:rgba(0,255,209,.08);box-shadow:0 0 0 1px rgba(0,255,209,.25),0 0 18px rgba(0,255,209,.18) inset,0 0 20px rgba(0,255,209,.15);color:#e5e7eb;font-size:12px;font-weight:700}
  .link-btn:hover{box-shadow:0 0 0 1px rgba(0,255,209,.4),0 0 26px rgba(0,255,209,.25) inset,0 0 26px rgba(0,255,209,.22)}
  .actions{display:flex;gap:10px;justify-content:space-between}
  .btn{padding:6px 9px;border-radius:12px;border:1px solid #2b3244;background:#0f1117;color:#e5e7eb;cursor:pointer;font-size:12.5px}
  .btn:hover{border-image:var(--rainbow) 1;border-width:1px;border-style:solid}
  .btn .zh{display:block;font-weight:800}.btn .en{display:block;font-size:11px;opacity:.9;font-weight:700}
  .cat-wrap{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;opacity:.9;z-index:30}
  .cat-btn{width:56px;height:56px;border-radius:50%;background:#0f1117;border:1px solid #2b3244;display:grid;place-items:center;cursor:pointer;transition:transform .08s ease, box-shadow .2s}
  .cat-btn:hover{box-shadow:0 0 0 2px rgba(255,255,255,.06), 0 8px 20px rgba(0,0,0,.35)} .cat-btn:active{transform:scale(.97)}
  .cat svg{width:30px;height:30px;stroke:#e5e7eb}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.45);opacity:0;transition:opacity .25s;z-index:60}
  .toast.show{opacity:1}
  .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
  .modal{width:min(640px,92vw);background:#0f1117;border-radius:16px;border:1px solid #2b3244;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal .title2{margin:0 0 10px;font-size:18px;font-weight:800}
  .modal .rb{height:2px;background:var(--rainbow);opacity:.5;border-radius:2px;margin-bottom:10px}
  .opts{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 8px}
  .opt{flex:1;min-width:240px;padding:10px 12px;border-radius:12px;border:1px dashed #2b3244;background:#0f1117;color:#9aa4af;cursor:pointer;text-align:center;font-weight:800}
  .opt.active{color:#0b0c10;background:linear-gradient(90deg,#a7f3d0,#93c5fd);border:0}
  textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3244;background:#0f1117;color:#e5e7eb;min-height:90px}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .btn-line{border:1px solid #2b3244;background:#0f1117;color:#e5e7eb}
  .btn-fill{background:transparent;border:1px solid transparent;border-image:var(--rainbow) 1;font-weight:900}

  /* === 預覽視窗調整：預設「完整呈現」＋可放大縮小 === */
  #previewViewport{max-height:70vh;max-width:calc(96vw - 40px);overflow:auto;display:grid;place-items:center;padding:6px}
  #invitePreviewImg{
    max-width:100%;
    max-height:70vh;             /* 先完整看到整張 */
    height:auto; width:auto;
    border-radius:12px;border:1px solid #2b3244;
    transition: transform .15s ease;
    cursor: zoom-in;
    transform-origin: center center;
  }
  #invitePreviewImg.zoomed{
    max-width:none; max-height:none;   /* 放大時解除限制，靠 transform 縮放 */
    cursor: zoom-out;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title tl">
      <div class="t1">Taiwan Pride 🌈</div>
      <div class="t2">Reservation Confirmation</div>
      <div class="t3">10/24 週五晚餐名單</div>
    </div>
    <div class="rainbow-line"></div>

    <div id="stats" class="stats" aria-label="status summary">
      <div class="chip ok"><span class="dot"></span><span class="lab">已確認</span><b class="num" id="statOk">0</b></div>
      <div class="chip warn"><span class="dot"></span><span class="lab">未回覆</span><b class="num" id="statWarn">0</b></div>
      <div class="chip bad"><span class="dot"></span><span class="lab">取消</span><b class="num" id="statBad">0</b></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="input-wrap">
          <label>姓名 / NAME</label>
          <input id="nameInput" list="nameList" placeholder="輸入或選擇姓名 / Type or choose a name" />
          <datalist id="nameList"></datalist>
        </div>
        <div class="input-wrap">
          <label>IG 帳號 / IG</label>
          <input id="igInput" list="igList" placeholder="輸入或選擇 IG / Type or choose IG" />
          <datalist id="igList"></datalist>
        </div>
        <div class="input-wrap">
          <button id="searchBtn" class="primary">搜尋 / Search</button>
        </div>
      </div>

      <div id="bgPreview" class="preview" aria-label="invitation previews"></div>

      <div id="head" class="result-head">資料載入中… / Loading roster… <span class="spinner" aria-hidden="true"></span></div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <div class="cat-wrap" aria-label="hidden-control">
    <div id="btnUploadBG" class="cat-btn" title="上傳邀請卡底圖 Upload invitation background">
      <img src="RAKU.png" alt="Upload background" class="upload-icon">
    </div>
  </div>

  <input id="fileBG" type="file" accept="image/*" style="display:none" />

  <!-- Confirm Modal -->
  <div id="confirmBackdrop" class="backdrop">
    <div class="modal">
      <div class="title2">出席確認 / Attendance Confirmation</div>
      <div class="rb"></div>
      <div class="opts">
        <div class="opt" data-val="confirmed">確認訂位，我會參加<br>Confirm reservation</div>
        <div class="opt" data-val="cancelled">抱歉，無法參加<br>Sorry - cannot attend</div>
      </div>
      <div class="input-wrap"><label>備註 / Notes</label><textarea id="noteArea" placeholder="寫點想說的話 / Leave a note"></textarea></div>
      <div class="actions">
        <button id="confirmCancel" class="btn btn-line"><span class="zh">取消</span><span class="en">Cancel</span></button>
        <button id="confirmSubmit" class="btn btn-fill"><span class="zh">送出</span><span class="en">Submit</span></button>
      </div>
    </div>
  </div>

  <!-- 預覽 Modal（不改結構，只加 id 方便控制） -->
  <div id="previewBackdrop" class="backdrop">
    <div class="modal" style="width:min(860px,96vw);">
      <div class="title2">邀請函預覽 / Invite Preview</div>
      <div class="rb"></div>
      <div id="previewViewport">
        <img id="invitePreviewImg" alt="Invite preview"/>
      </div>
      <div class="actions">
        <a id="btnDownloadPNG" class="btn btn-fill" href="#" download="invite.png">
          <span class="zh">下載 PNG</span><span class="en">Download PNG</span>
        </a>
        <button id="previewClose" class="btn btn-line"><span class="zh">關閉</span><span class="en">Close</span></button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxJdToNoRIc2q5-jT53c6jwcD6WNNDbNOBmhqE2ulDLmNDsBDo86hCVqj32AI9Fp53n/exec';
const PASSWORD = '0714';

const state = { rows: [], bgImages: [], selected: null, confirmChoice: null };

const $ = (id)=>document.getElementById(id);
const showToast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500) };
const norm = (s)=> (s||'').toString().trim().toLowerCase();
const unique = (arr)=>[...new Set(arr)];
const by = (k)=>(a,b)=> (a[k]||'').localeCompare(b[k]||'');

function setHeadLoading(isLoading){
  const head = $('head');
  if(!head) return;
  if(isLoading){ head.innerHTML = '資料載入中… / Loading roster… <span class="spinner" aria-hidden="true"></span>'; }
  else{ head.textContent = '請於上方輸入「姓名或 IG」後搜尋 / Type NAME or IG to search'; }
}

async function fetchRoster(){
  try{
    if(!WEB_APP_URL){ $('head').textContent='尚未設定資料端點 / No WEB_APP_URL'; return; }
    setHeadLoading(true);
    const res = await fetch(WEB_APP_URL + '?mode=roster', { method:'GET', cache:'no-store' });
    if(!res.ok) throw new Error('network');
    const data = await res.json();
    state.rows = Array.isArray(data) ? data : (data.rows || []);
    rebuildDatalists(); renderStats(); setHeadLoading(false);
  }catch(e){ console.error(e); $('head').textContent = '名單載入失敗 / Failed to load roster'; }
}

function rebuildDatalists(){
  const dlN = $('nameList'), dlI = $('igList');
  dlN.innerHTML = ''; dlI.innerHTML = '';
  unique(state.rows.map(r=>r.name).filter(Boolean).sort()).forEach(v=>{
    const o=document.createElement('option'); o.value=v; dlN.appendChild(o);
  });
  unique(state.rows.map(r=>r.ig).filter(Boolean).sort()).forEach(v=>{
    const o=document.createElement('option'); o.value=v; dlI.appendChild(o);
  });
}

async function tryLoadCardBackgrounds(){
  const candidates = ['card.png','card.jpg','card.jpeg','card.webp','card.svg'];
  for(const name of candidates){
    try{
      const img = await loadImageRelative(name);
      state.bgImages = [img];
      renderBGPreview();
      showToast('已自動載入 card 底圖');
      return;
    }catch(_){}
  }
}
function loadImageRelative(src){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=> resolve(img);
    img.onerror = ()=> reject(new Error('not found'));
    img.src = src;
  });
}

$('btnUploadBG').addEventListener('click', ()=>{
  const p = prompt('請輸入密碼 / Enter password');
  if(p===null) return;
  if(p!==PASSWORD){ showToast('密碼錯誤 / Wrong password'); return; }
  $('fileBG').click();
});
$('fileBG').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  state.bgImages = [];
  for(const f of files){ const img = await fileToImage(f); state.bgImages.push(img); }
  renderBGPreview(); showToast('邀請函底圖已載入 / Invitation background loaded'); e.target.value='';
});
function fileToImage(file){
  return new Promise((res,rej)=>{
    const img=new Image(); img.onload=()=>res(img); img.onerror=rej;
    img.src=URL.createObjectURL(file);
  });
}
function renderBGPreview(){
  const box=$('bgPreview'); box.innerHTML='';
  state.bgImages.forEach(img=>{ const el=document.createElement('img'); el.src=img.src; box.appendChild(el); });
}

$('searchBtn').addEventListener('click', search);
$('nameInput').addEventListener('keydown',e=>{if(e.key==='Enter') search(); renderStats();});
$('igInput').addEventListener('keydown',e=>{if(e.key==='Enter') search(); renderStats();});

function search(){
  const qn = norm($('nameInput').value), qi = norm($('igInput').value);
  if(!state.rows.length){ showToast('雲端名單尚未就緒 / Roster not ready'); return; }
  let sel = null;
  if(qi) sel = state.rows.find(r=>norm(r.ig)===qi);
  if(!sel && qn) sel = state.rows.find(r=>norm(r.name)===qn);
  let rows=[]; let leader='';
  if(sel){ leader = sel.leader; rows = state.rows.filter(r=>norm(r.leader)===norm(leader)); }
  else{
    const cand = state.rows.filter(r=> (qi && norm(r.ig).includes(qi)) || (qn && norm(r.name).includes(qn)) );
    if(cand.length){ leader = cand[0].leader; rows = state.rows.filter(r=>norm(r.leader)===norm(leader)); }
  }
  renderList(rows, leader);
}

function renderList(rows, leader){
  const grid = $('grid'); grid.innerHTML='';
  if(!rows || !rows.length){ $('head').textContent='查無資料 / No results'; return; }
  $('head').innerHTML = leader
    ? `桌長 / Leader：<b class="rbtext">${leader||'—'}</b>（${rows.length} 筆 / records）`
    : `共 ${rows.length} 筆 / records`;
  rows.sort((a,b)=> by('country')(a,b) || by('name')(a,b));
  for(const r of rows){ grid.appendChild(renderPerson(r)); }
}
function renderPerson(r){
  const card = document.createElement('div'); card.className='person';
  const L1 = document.createElement('div'); L1.className='line';
  const left1 = document.createElement('div'); left1.className='left namebar';
  const flag = document.createElement('div'); flag.className='flag'; flag.textContent = r.flag || '—';
  const ctry = document.createElement('span'); ctry.className='country'; ctry.textContent = (r.country||'—');
  const personN = document.createElement('span'); personN.className='personN'; personN.textContent = (r.name||'—');
  const ig = document.createElement('span'); ig.className='ig'; ig.textContent = (r.ig||'—');
  left1.append(flag, ctry, personN, ig); L1.append(left1);

  const L2 = document.createElement('div'); L2.className='line';
  const left2 = document.createElement('div'); left2.className='left'; left2.append(buildStatus(r.status));
  const right2 = document.createElement('div'); right2.className='right';
  if(r.link){
    const a=document.createElement('a'); a.href=r.link; a.target='_blank'; a.rel='noopener noreferrer'; a.className='link-btn ig-btn';
    const img=document.createElement('img'); img.src='pngsucai_1605688_ec16ce.png'; img.alt='Instagram'; img.className='ig-icon';
    a.appendChild(img); right2.appendChild(a);
  }
  L2.append(left2,right2);

  const L3 = document.createElement('div'); L3.className='actions';
  const btnC = document.createElement('button'); btnC.className='btn'; btnC.innerHTML='<span class="zh">確認</span><span class="en">Confirm</span>'; btnC.addEventListener('click',()=> openConfirm(r));
  const btnD = document.createElement('button'); btnD.className='btn'; btnD.innerHTML='<span class="zh">邀請函下載</span><span class="en">Download Invite</span>'; btnD.addEventListener('click',()=> downloadInvite(r));
  L3.append(btnC, btnD);
  card.append(L1,L2,L3);
  return card;
}
function buildStatus(status){
  const box=document.createElement('div'); box.className='status';
  const s = (status||'').toString().trim().toLowerCase();
  let type='warn', zh='未回覆', en='Pending', iconType='warn';
  if(s==='confirmed'){ type='ok'; zh='已確定訂位'; en='Confirmed'; iconType='ok'; }
  else if(s==='cancelled'){ type='bad'; zh='取消參加'; en='Cancelled'; iconType='bad'; }
  const badge=document.createElement('div'); badge.className='badge '+type; badge.innerHTML = svgIcon(iconType);
  const lab=document.createElement('div'); lab.className='status-label'; lab.innerHTML = `<span class="zh">${zh}</span><span class="en">${en}</span>`;
  box.append(badge,lab); return box;
}
function svgIcon(kind){
  if(kind==='ok'){ return `<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M7 12.5l3 3 6-6"/></svg>`; }
  if(kind==='bad'){ return `<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M8 8l8 8M16 8l-8 8"/></svg>`; }
  return `<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><text class="glyph-text" x="12" y="12">?</text></svg>`;
}

/* ===== Confirm Modal ===== */
const modal=$('confirmBackdrop'), noteArea=$('noteArea'), btnSubmit=$('confirmSubmit');
document.querySelectorAll('.opt').forEach(el=> el.addEventListener('click',()=> selectOpt(el)) );
$('confirmCancel').addEventListener('click', ()=> closeModal());
function openConfirm(person){ state.selected = person; state.confirmChoice = null; noteArea.value=''; document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active')); modal.style.display='flex'; }
function selectOpt(el){ document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active')); el.classList.add('active'); state.confirmChoice = el.dataset.val; }
function closeModal(){ modal.style.display='none'; }
btnSubmit.addEventListener('click', async ()=>{
  if(!state.confirmChoice){ showToast('請選擇一個選項 / Please choose an option'); return; }
  const person = state.selected; if(!person){ closeModal(); return; }
  const payload = { action:'updateStatus', item: person.item, number: person.number, country: person.country, flag: person.flag, name: person.name, ig: person.ig, leader: person.leader, link: person.link, status: state.confirmChoice, notes: noteArea.value.trim(), ts: Date.now() };
  btnSubmit.disabled=true; btnSubmit.textContent='傳送中… / Sending…';
  try{
    const res = await fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload), mode:'cors', cache:'no-store' });
    let ok=false; try{ const j=await res.json(); ok=!!j.ok || Array.isArray(j); }catch{ ok=res.ok; }
    if(!ok) throw new Error('SERVER_NOK');
    person.status = state.confirmChoice;
    showToast('已送出並更新狀態 / Submitted & updated'); closeModal(); search(); renderStats();
  }catch(err){ console.error(err); showToast('送出失敗，請稍後再試 / Failed to submit'); }
  finally{ btnSubmit.disabled=false; btnSubmit.textContent='送出 / Submit'; }
});

/* ===== (9) 邀請卡：底部中間 QR + 小號 number，彈窗預覽 + 穩定下載 ===== */
async function downloadInvite(person){
  if(!state.bgImages.length){ showToast('找不到邀請卡底圖，請放同資料夾的 card.* 或用 RAKU 上傳'); return; }
  const content = (person.qrcode || '').toString().trim();
  const numberText = (person.number || '').toString();
  if(!content){ showToast('此列沒有 qrcode 欄位內容'); return; }

  const bg = state.bgImages[0];
  const W = bg.naturalWidth || bg.width, H = bg.naturalHeight || bg.height;

  const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
  canvas.width = W; canvas.height = H;

  ctx.drawImage(bg,0,0,W,H);

  const margin = 0.08 * Math.min(W,H);
  const qrSize = Math.floor(0.22 * W);
  const textGap = qrSize / 3;
  const qrX = Math.floor((W - qrSize) / 2);
  const qrY = Math.floor(H - margin - qrSize - textGap);

  const encoded = encodeURIComponent(content);
  const apiURL = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&ecc=M&data=${encoded}`;
  const qrImg = new Image(); qrImg.crossOrigin='anonymous';
  await new Promise((res,rej)=>{ qrImg.onload=res; qrImg.onerror=()=>rej(new Error('QR API 載入失敗')); qrImg.src=apiURL; });

  ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

  const fontSize = Math.max(10, Math.floor(qrSize * 0.25));
  ctx.font = `800 ${fontSize}px ui-sans-serif, system-ui, "Noto Sans TC","Microsoft JhengHei"`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillStyle='#ffffff'; ctx.strokeStyle='rgba(0,0,0,.38)'; ctx.lineWidth = Math.ceil(fontSize * 0.14);

  const textCX = qrX + qrSize/2;
  const textCY = qrY + qrSize + (qrSize/3);
  ctx.strokeText(numberText, textCX, textCY);
  ctx.fillText(numberText, textCX, textCY);

  // 以 Blob 產生可下載/可預覽的 URL（比 dataURL 可靠）
  canvas.toBlob((blob)=>{
    if(!blob){ showToast('產生影像失敗'); return; }
    const url = URL.createObjectURL(blob);
    const img = $('invitePreviewImg');
    const dl = $('btnDownloadPNG');

    // 預覽一開始先「完整呈現」
    img.classList.remove('zoomed');
    img.style.transform = 'scale(1)';
    img.dataset.scale = '1';
    img.src = url;

    // 設定下載
    const safeName = (person.name||'guest').replace(/[^\w\u4e00-\u9fa5-]+/g,'_');
    dl.download = `invite_${person.number||''}_${safeName}.png`;
    dl.href = url;

    // 下載後釋放 URL（延遲避免還在使用）
    dl.onclick = () => { setTimeout(()=> URL.revokeObjectURL(url), 2000); };

    openPreview();
  }, 'image/png');
}

/* === 預覽彈窗與縮放控制 === */
const previewBackdrop = $('previewBackdrop');
const previewViewport = $('previewViewport');
const previewImg = $('invitePreviewImg');
$('previewClose').addEventListener('click', closePreview);

function openPreview(){ previewBackdrop.style.display='flex'; }
function closePreview(){ previewBackdrop.style.display='none'; }

/* 點擊切換放大/還原 */
previewImg.addEventListener('click', ()=>{
  const zoomed = previewImg.classList.toggle('zoomed');
  if(!zoomed){
    previewImg.style.transform = 'scale(1)'; previewImg.dataset.scale = '1';
  }else{
    const s = 2; previewImg.style.transform = `scale(${s})`; previewImg.dataset.scale = String(s);
  }
});

/* 滾輪縮放（在預覽區域內） */
previewViewport.addEventListener('wheel', (e)=>{
  if(!previewImg.src) return;
  e.preventDefault();
  let scale = parseFloat(previewImg.dataset.scale || '1');
  const delta = e.deltaY > 0 ? -0.1 : 0.1;
  scale = Math.min(5, Math.max(1, scale + delta));
  if(scale === 1){
    previewImg.classList.remove('zoomed');
  }else{
    previewImg.classList.add('zoomed');
  }
  previewImg.dataset.scale = String(scale);
  previewImg.style.transform = `scale(${scale})`;
}, { passive:false });

/* ===== 啟動 ===== */
function init(){ fetchRoster(); tryLoadCardBackgrounds(); }
init();

function renderStats(){
  const ok = state.rows.filter(r => (r.status||'').toString().trim().toLowerCase()==='confirmed').length;
  const bad = state.rows.filter(r => (r.status||'').toString().trim().toLowerCase()==='cancelled').length;
  const warn = state.rows.length - ok - bad;
  const elOk = $('statOk'), elWarn = $('statWarn'), elBad = $('statBad');
  if(elOk) elOk.textContent = ok; if(elWarn) elWarn.textContent = warn; if(elBad) elBad.textContent = bad;
}
</script>
</body>
</html>
